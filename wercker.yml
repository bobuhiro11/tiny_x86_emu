box: ubuntu
build:
  steps:
    - wercker/setup-go-workspace:
      package-dir: github.com/nmi/tiny_x86_emu
    - script:
        name: init
        code: |
          sudo apt-get update
          sudo apt-get install -y nasm gcc git tar wget make bsdmainutils libglu1-mesa-dev libgles2-mesa-dev libxrandr-dev libxcursor-dev libxinerama-dev libxi-dev libasound2-dev qemu gdb unzip python
          wget https://dl.google.com/go/go1.11.linux-amd64.tar.gz
          sudo tar -C /usr/local -zxf go1.11.linux-amd64.tar.gz
    - script:
        name: install unicorn
        code: |
             wget https://github.com/unicorn-engine/unicorn/archive/master.zip
             unzip master.zip
             pushd unicorn-master/
             ./make.sh
             sudo ./make.sh install
             popd
    - script:
        name: check dependencies
        code: |
          go version
          uname -a
          gcc --version
          objdump --version
          nasm -v
          ndisasm -v
    - script:
        name: go get
        code: |
          go get -u -v github.com/mattn/goveralls
          go get -u -v github.com/goreleaser/goreleaser
          go get -u -v github.com/golang/dep/...
          go get -u -v github.com/golang/lint/golint
          go get -u -v github.com/unicorn-engine/unicorn/bindings/go
          # glfw cannot be managed by dep
          go get -u -v github.com/go-gl/glfw/v3.2/glfw/...
          go get -u -v github.com/go-gl/gl/v2.1/gl/...
          go get -u -v github.com/jessevdk/go-assets-builder
    - script:
        name: dep ensure
        code: |
          dep ensure -v
    - script:
        name: go build
        code: |
          make build
    - script:
        name: go test
        code: |
          make test
